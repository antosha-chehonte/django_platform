{% extends "base.html" %}
{% load static %}

{% block content %}
<h3>{% if object %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–°–æ–∑–¥–∞–Ω–∏–µ{% endif %} —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∏</h3>

{% if not object %}
<div class="alert alert-success mb-4">
    <h5 class="alert-heading">‚ú® –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</h5>
    <p class="mb-0">
        –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (.cer –∏–ª–∏ .pfx) –∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á–µ—Ç –∏–∑ –Ω–µ–≥–æ:
    </p>
    <ul class="mb-0 mt-2">
        <li>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</li>
        <li>–û—Ç–ø–µ—á–∞—Ç–æ–∫ (SHA-1 fingerprint)</li>
        <li>–î–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è</li>
    </ul>
    <p class="mb-0 mt-2">
        <strong>–ü—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"</strong> - –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
    </p>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" class="mt-4">
    {% csrf_token %}
    
    <div class="card">
        <div class="card-body">
            <div class="mb-3">
                <label for="{{ form.employee.id_for_label }}" class="form-label">
                    {{ form.employee.label }} <span class="text-danger">*</span>
                </label>
                {{ form.employee }}
                {% if form.employee.errors %}
                    <div class="text-danger">{{ form.employee.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.certificate_type.id_for_label }}" class="form-label">
                    {{ form.certificate_type.label }} <span class="text-danger">*</span>
                </label>
                {{ form.certificate_type }}
                {% if form.certificate_type.errors %}
                    <div class="text-danger">{{ form.certificate_type.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.certificate_serial.id_for_label }}" class="form-label">
                    {{ form.certificate_serial.label }} <span class="text-danger">*</span>
                </label>
                {{ form.certificate_serial }}
                {% if form.certificate_serial.errors %}
                    <div class="text-danger">{{ form.certificate_serial.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.certificate_alias.id_for_label }}" class="form-label">
                    {{ form.certificate_alias.label }} <span class="text-danger">*</span>
                </label>
                {{ form.certificate_alias }}
                {% if form.certificate_alias.errors %}
                    <div class="text-danger">{{ form.certificate_alias.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.expiry_date.id_for_label }}" class="form-label">
                    {{ form.expiry_date.label }} <span class="text-danger">*</span>
                </label>
                {{ form.expiry_date }}
                {% if form.expiry_date.errors %}
                    <div class="text-danger">{{ form.expiry_date.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.carrier_serial.id_for_label }}" class="form-label">
                    {{ form.carrier_serial.label }}
                </label>
                {{ form.carrier_serial }}
                {% if form.carrier_serial.errors %}
                    <div class="text-danger">{{ form.carrier_serial.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.certificate_file.id_for_label }}" class="form-label">
                    {{ form.certificate_file.label }}
                </label>
                {{ form.certificate_file }}
                {% if form.certificate_file.errors %}
                    <div class="text-danger">{{ form.certificate_file.errors }}</div>
                {% endif %}
                {% if form.certificate_file.help_text %}
                    <div class="form-text">{{ form.certificate_file.help_text }}</div>
                {% endif %}
            </div>
            
            {% if form.auto_fill_from_certificate %}
            <div class="mb-3">
                <div class="form-check">
                    {{ form.auto_fill_from_certificate }}
                    <label class="form-check-label" for="{{ form.auto_fill_from_certificate.id_for_label }}">
                        {{ form.auto_fill_from_certificate.label }}
                    </label>
                    {% if form.auto_fill_from_certificate.help_text %}
                        <div class="form-text">{{ form.auto_fill_from_certificate.help_text }}</div>
                    {% endif %}
                </div>
                <div class="alert alert-info mt-2">
                    <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (.cer –∏–ª–∏ .pfx) –ø–æ–ª—è 
                    <strong>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</strong>, <strong>–û—Ç–ø–µ—á–∞—Ç–æ–∫</strong> –∏ <strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</strong> 
                    –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞. –°—Ç–∞—Ç—É—Å —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                </div>
            </div>
            {% endif %}
            
            <div class="mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">
                    {{ form.status.label }} <span class="text-danger">*</span>
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="text-danger">{{ form.status.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.notes.id_for_label }}" class="form-label">
                    {{ form.notes.label }}
                </label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <div class="text-danger">{{ form.notes.errors }}</div>
                {% endif %}
            </div>
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
        </div>
        
        <div class="card-footer">
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{% url 'access:digital_signature_list' %}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </div>
</form>

{% if not object %}
<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    const certificateFileInput = document.getElementById('{{ form.certificate_file.id_for_label }}');
    const autoFillCheckbox = document.getElementById('{{ form.auto_fill_from_certificate.id_for_label }}');
    
    if (certificateFileInput && autoFillCheckbox && autoFillCheckbox.checked) {
        certificateFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && (file.name.toLowerCase().endsWith('.cer') || file.name.toLowerCase().endsWith('.pfx'))) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingAlert = document.createElement('div');
                loadingAlert.className = 'alert alert-info mt-2';
                loadingAlert.id = 'cert-parsing-loading';
                loadingAlert.innerHTML = '<strong>‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞...</strong>';
                certificateFileInput.parentElement.appendChild(loadingAlert);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
                const formData = new FormData();
                formData.append('certificate_file', file);
                
                // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                const csrftoken = getCookie('csrftoken');
                
                fetch('{% url "access:certificate_parse_ajax" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    loadingAlert.remove();
                    
                    if (data.success) {
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
                        const serialInput = document.getElementById('{{ form.certificate_serial.id_for_label }}');
                        const aliasInput = document.getElementById('{{ form.certificate_alias.id_for_label }}');
                        const expiryInput = document.getElementById('{{ form.expiry_date.id_for_label }}');
                        const statusSelect = document.getElementById('{{ form.status.id_for_label }}');
                        
                        if (serialInput && !serialInput.value) {
                            serialInput.value = data.data.certificate_serial;
                            serialInput.classList.add('border-success');
                        }
                        
                        if (aliasInput && !aliasInput.value) {
                            aliasInput.value = data.data.certificate_alias;
                            aliasInput.classList.add('border-success');
                        }
                        
                        if (expiryInput && !expiryInput.value) {
                            expiryInput.value = data.data.expiry_date;
                            expiryInput.classList.add('border-success');
                        }
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ–≥–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞
                        if (statusSelect) {
                            statusSelect.value = data.data.status;
                            statusSelect.classList.add('border-success');
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                        const successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success mt-2';
                        successAlert.innerHTML = '<strong>‚úÖ –£—Å–ø–µ—à–Ω–æ!</strong> –ü–æ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.';
                        certificateFileInput.parentElement.appendChild(successAlert);
                        
                        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                        setTimeout(() => successAlert.remove(), 5000);
                        
                        // –£–±–∏—Ä–∞–µ–º –∑–µ–ª–µ–Ω—É—é —Ä–∞–º–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            [serialInput, aliasInput, expiryInput, statusSelect].forEach(input => {
                                if (input) input.classList.remove('border-success');
                            });
                        }, 3000);
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        const errorAlert = document.createElement('div');
                        errorAlert.className = 'alert alert-warning mt-2';
                        errorAlert.innerHTML = '<strong>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> ' + data.error + ' –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –≤—Ä—É—á–Ω—É—é.';
                        certificateFileInput.parentElement.appendChild(errorAlert);
                    }
                })
                .catch(error => {
                    loadingAlert.remove();
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger mt-2';
                    errorAlert.innerHTML = '<strong>‚ùå –û—à–∏–±–∫–∞:</strong> –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª. ' + error.message;
                    certificateFileInput.parentElement.appendChild(errorAlert);
                });
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}

