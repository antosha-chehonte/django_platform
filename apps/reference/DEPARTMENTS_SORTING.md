# Система сортировки подразделений через поле `sorting`

## Описание

Поле `sorting` в модели `Departments` используется для организации иерархической структуры подразделений в отсортированном виде. Каждое подразделение на каждом уровне иерархии располагается в определенном порядке.

## Формат кода сортировки

Код сортировки представляет собой путь в формате: `001`, `001.001`, `001.002.001` и т.д.

### Правила формирования:

1. **Корневые элементы** (без родителя): используют формат `001`, `002`, `003` и т.д.
   - Каждый сегмент состоит из 3 цифр
   - Сегменты разделяются точкой

2. **Дочерние элементы**: используют формат `родительский_код.001`, `родительский_код.002` и т.д.
   - Например, если родитель имеет код `001`, то дочерние элементы будут: `001.001`, `001.002`, `001.003` и т.д.

3. **Вложенные элементы**: каждый уровень добавляет свой сегмент
   - Например: `001.001.001` - третий уровень вложенности

### Примеры:

```
001          Администрация
001.001      Отдел продаж
001.001.001  Сектор оптовых продаж
001.001.002  Сектор розничных продаж
001.002      Отдел закупок
001.002.001  Группа закупок оборудования
001.002.002  Группа закупок ПО

002          Бухгалтерия
002.001      Отдел расчёта зарплаты

003          IT-служба
003.001      Отдел разработки
003.001.001  Команда разработки ядра
003.001.002  Команда разработки UI
003.002      Отдел эксплуатации
```

## Автоматическая генерация

Система автоматически генерирует код сортировки при создании нового подразделения:

1. **Если поле `sorting` не заполнено** - код генерируется автоматически на основе родительского подразделения
2. **Если указан родитель** - код формируется как `родительский_код.001` (или следующий доступный номер)
3. **Если родитель не указан** - код формируется как `001` (или следующий доступный номер среди корневых элементов)

## Ручное заполнение

Поле `sorting` можно заполнить вручную, но необходимо соблюдать формат:
- Сегменты по 3 цифры
- Разделение точкой
- Соответствие иерархии (код должен начинаться с кода родителя, если родитель указан)

## Валидация

Система проверяет формат кода сортировки:
- При сохранении через формы (Django forms)
- При импорте из CSV
- При сохранении через админ-панель

Формат проверяется регулярным выражением: `^(\d{3})(\.\d{3})*$`

## Изменение родителя

При изменении родительского подразделения:
1. Код сортировки автоматически пересчитывается на основе нового родителя
2. Все дочерние элементы также получают новые коды сортировки (рекурсивно)

## Использование в запросах

Благодаря формату пути, можно легко:
- Сортировать все подразделения: `Departments.objects.all().order_by('sorting')`
- Фильтровать по ветке: `Departments.objects.filter(sorting__startswith='001.002')`
- Получить все подразделения определенного уровня

## Методы модели

### `get_next_sorting_code(parent=None, exclude_pk=None)`
Статический метод для генерации следующего кода сортировки.

### `update_children_sorting()`
Обновляет коды сортировки всех дочерних элементов при изменении родителя.

### `get_all_descendants()`
Возвращает все дочерние подразделения (рекурсивно).

### `get_level()`
Возвращает уровень вложенности (0 для корневых элементов).

## Импорт из CSV

При импорте из CSV:
- Если поле `sorting` заполнено - используется указанное значение (с валидацией)
- Если поле `sorting` пустое - код генерируется автоматически на основе родительского подразделения

## Примеры использования в коде

```python
# Создание корневого подразделения
dept1 = Departments(name="Администрация", code="ADM001")
dept1.save()  # sorting будет автоматически установлен как "001"

# Создание дочернего подразделения
dept2 = Departments(name="Отдел продаж", code="SALES001", parent=dept1)
dept2.save()  # sorting будет автоматически установлен как "001.001"

# Получение всех подразделений в отсортированном виде
departments = Departments.objects.filter(is_active=True).order_by('sorting')

# Получение всех подразделений определенной ветки
branch = Departments.objects.filter(sorting__startswith='001.002')
```

